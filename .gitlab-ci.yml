image: "ruby:2.5"

services:
  - postgres:alpine

stages:
  - test
  - deploy

test_all:
  stage: test
  variables:
    POSTGRES_USER: test
    POSTGRES_PASSSWORD: test-password
    POSTGRES_DB: test_db
    DATABASE_URL: postgres://${POSTGRES_USER}:${POSTGRES_PASSSWORD}@postgres/${POSTGRES_DB}
    RAILS_ENV: test

  before_script:
    - apt-get update -qq && apt-get install -yqq nodejs libpq-dev
    - apt-get install redis-server -y
    - apt-get install -y unzip xvfb libxi6 libgconf-2-4
    - apt-get install default-jdk 
    - curl -sS -o - https://dl-ssl.google.com/linux/linux_signing_key.pub | apt-key add
    - echo "deb [arch=amd64]  http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google-chrome.list
    - apt-get -y update
    - apt-get -y install google-chrome-stable
    - apt-get install -yq gconf-service libasound2 libatk1.0-0 libc6 libcairo2 libcups2 libdbus-1-3 libexpat1 libfontconfig1 libgcc1 libgconf-2-4 libgdk-pixbuf2.0-0 libglib2.0-0 libgtk-3-0 libnspr4 libpango-1.0-0 libpangocairo-1.0-0 libstdc++6 libx11-6 libx11-xcb1 libxcb1 libxcomposite1 libxcursor1 libxdamage1 libxext6 libxfixes3 libxi6 libxrandr2 libxrender1 libxss1 libxtst6 ca-certificates fonts-liberation libappindicator1 libnss3 lsb-release xdg-utils wget
    - gem install bundler  --no-ri --no-rdoc
    - bundle install
    - rails db:migrate

  script:
    - rubocop
    - rails test

production_deploy:
  stage: deploy
  variables:
    RAILS_ENV: production
  only:
    - master
  before_script:
    - 'which ssh-agent || ( apt-get update -y && apt-get install openssh-client -y )'
    - eval "$(ssh-agent -s)"
    - ssh-add <(echo -e "$SSH_PRIVATE_KEY")
    - gem install bundler  --no-ri --no-rdoc
    - bundle install
  script:
    - bundle exec cap production deploy
