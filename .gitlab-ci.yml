image: "ruby:2.5"

services:
  - postgres:alpine
  - redis:latest
stages:
  - test
  - deploy

test_all:
  stage: test
  variables:
    POSTGRES_USER: test
    POSTGRES_PASSSWORD: test-password
    POSTGRES_DB: test_db
    DATABASE_URL: postgres://${POSTGRES_USER}:${POSTGRES_PASSSWORD}@postgres/${POSTGRES_DB}
    RAILS_ENV: test

  before_script:
    - apt-get update -qq && apt-get install -yqq nodejs libpq-dev
    - gem install bundler  --no-ri --no-rdoc
    - bundle install
    - rails db:migrate
    - rails db:seed

  script:
    - rubocop
    - rails test

production_deploy:
  stage: deploy
  variables:
    RAILS_ENV: production
  only:
    - master
  before_script:
    - 'which ssh-agent || ( apt-get update -y && apt-get install openssh-client -y )'
    - eval "$(ssh-agent -s)"
    - ssh-add <(echo -e "$SSH_PRIVATE_KEY")
    - gem install bundler  --no-ri --no-rdoc
    - bundle install
  script:
    - bundle exec cap production deploy
